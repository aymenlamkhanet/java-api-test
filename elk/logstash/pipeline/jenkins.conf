# ==========================================
# Logstash Pipeline pour Jenkins CI/CD Logs
# ==========================================

input {
  # Recevoir les logs via HTTP
  http {
    port => 5044
    codec => json
    type => "jenkins-pipeline"
  }
  
  # Alternative: Recevoir via TCP
  tcp {
    port => 5000
    codec => json_lines
    type => "jenkins-pipeline"
  }
}

filter {
  # Parser les timestamps
  date {
    match => ["timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ"]
    target => "@timestamp"
  }
  
  # Enrichir avec des métadonnées
  mutate {
    add_field => {
      "pipeline_name" => "%{[pipeline]}"
      "environment" => "ci-cd"
    }
  }
  
  # Classifier le niveau de log
  if [level] == "ERROR" or [status] == "FAILED" {
    mutate {
      add_field => { "severity" => "critical" }
      add_tag => ["alert", "failure"]
    }
  } else if [level] == "WARN" {
    mutate {
      add_field => { "severity" => "warning" }
      add_tag => ["warning"]
    }
  } else {
    mutate {
      add_field => { "severity" => "info" }
    }
  }
  
  # Parser les métriques SonarQube si présentes
  if [stage] == "quality-gate" and [metrics] {
    ruby {
      code => '
        metrics = event.get("metrics")
        if metrics.is_a?(Hash)
          metrics.each do |key, value|
            event.set("[sonarqube][#{key}]", value)
          end
        end
      '
    }
  }
  
  # Parser les résultats de tests
  if [stage] == "unit-tests" and [test_results] {
    mutate {
      add_field => {
        "tests_passed" => "%{[test_results][passed]}"
        "tests_failed" => "%{[test_results][failed]}"
        "tests_skipped" => "%{[test_results][skipped]}"
      }
    }
  }
  
  # Parser les vulnérabilités Trivy
  if [stage] == "security-scan" and [vulnerabilities] {
    mutate {
      add_field => {
        "vuln_critical" => "%{[vulnerabilities][critical]}"
        "vuln_high" => "%{[vulnerabilities][high]}"
        "vuln_medium" => "%{[vulnerabilities][medium]}"
      }
    }
  }
}

output {
  # Envoyer vers Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "jenkins-pipeline-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }
  
  # Debug: Afficher dans la console Logstash
  stdout {
    codec => rubydebug
  }
}
